<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>elasticsearch优化,监控</title>
<meta name="description" content="elasticsearch优化,安装,监控" />
</head>
<body>
<p>
elasticsearch-sql&nbsp;地址：
https://github.com/NLPchina/elasticsearch-sql</p>

<p>curl&nbsp;-H&nbsp;"Content-Type:&nbsp;application/json"&nbsp;-XPOST&nbsp;'http://localhost:9200/_sql'&nbsp;-d&nbsp;'SELECT&nbsp;*&nbsp;FROM&nbsp;logstash-f1-hq-access-2017.11.29&nbsp;LIMIT&nbsp;10'</p>
curl&nbsp;-H&nbsp;"Content-Type:&nbsp;application/json"&nbsp;-XPOST&nbsp;'http://localhost:9200/_sql'&nbsp;-d&nbsp;'SELECT&nbsp;count(*)&nbsp;FROM&nbsp;logstash-f1-hq-access-2017.11.29&nbsp;where&nbsp;status=502'
查看elasticsearch状态：
curl&nbsp;127.0.0.1:9200/_cluster/health?pretty
curl&nbsp;localhost:9200/_cat/health
查看所有分片状态：
curl&nbsp;-XGET&nbsp;http://localhost:9200/_cat/shards

curl&nbsp;-XGET&nbsp;localhost:9200/_cluster/stats?pretty=true

curl&nbsp;'localhost:9200/_cat/nodes?v'


JAVA_OPTS="$JAVA_OPTS&nbsp;-Xmx4g&nbsp;-Xms4g&nbsp;-Xmn1g&nbsp;-Xss16m&nbsp;-XX:MetaspaceSize=512m&nbsp;-XX:MaxMetaspaceSize=1g"
#Xmn&nbsp;Java&nbsp;Heap&nbsp;Young区大小，不熟悉最好保留默认值，年轻代大小，一般为整个堆空间的1/4到1/3；
#&nbsp;-Xss16m每个线程的Stack大小，通常建议使用256K&nbsp;即可，但是ES单线程承载的数据量比较大
#MetaspaceSize&nbsp;使用堆内存以外的直接系统内存,只受可用的本地内存限制

[root@node5&nbsp;~]#&nbsp;redis-cli&nbsp;
127.0.0.1:6379&gt;&nbsp;KEYS&nbsp;*
1)&nbsp;"system-message-jack"&nbsp;#已经生成数据
127.0.0.1:6379&gt;&nbsp;LLEN&nbsp;&nbsp;system-message-jack&nbsp;#查看key的长度
(integer)&nbsp;681
127.0.0.1:6379&gt;&nbsp;LINDEX&nbsp;system-message-jack&nbsp;-1&nbsp;&nbsp;#查看最后一行数据
"{\"message\":\"Apr&nbsp;12&nbsp;14:03:53&nbsp;HTC-Server2&nbsp;snmpd[1573]:&nbsp;Connection&nbsp;from&nbsp;UDP:&nbsp;[60.195.252.107]:31001-&gt;[192.168.0.116]\",\"@version\":\"1\",\"@timestamp\":\"2016-04-12T08:37:51.025Z\",\"host\":\"node6.a.com\",\"path\":\"/var/log/messages\"}"

index.refresh_interval

若需要重启elasticsearch&nbsp;，&nbsp;为了避免重启期间shard&nbsp;的重新分配导致大量的流量，首先关闭shard&nbsp;allocation&nbsp;：
&nbsp;
curl&nbsp;-XPUT&nbsp;http://127.0.0.1:9200/_cluster/settings&nbsp;-d'
{
"transient"&nbsp;:&nbsp;{
"cluster.routing.allocation.enable"&nbsp;:&nbsp;"none"
}
}'
然后对elasticsearch&nbsp;重启，&nbsp;重启完成后：
&nbsp;
curl&nbsp;-XPUT&nbsp;http://127.0.0.1:9200/_cluster/settings&nbsp;-d'
{
"transient"&nbsp;:&nbsp;{
"cluster.routing.allocation.enable"&nbsp;:&nbsp;"all"
}
}'

PUT&nbsp;/logstash-mil-access-10-20160905
{
&nbsp;&nbsp;"settings":&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;"refresh_interval":&nbsp;"30s"&nbsp;
&nbsp;&nbsp;}
}


{&nbsp;"refresh_interval":&nbsp;60s&nbsp;}
curl&nbsp;PUT&nbsp;'http://localhost:9200/logstash-mil-access-10-20160905
{
&nbsp;&nbsp;"settings":&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;"refresh_interval":&nbsp;"30s"&nbsp;
&nbsp;&nbsp;}
}
}'


#!/bin/sh

TODAY=`date&nbsp;&nbsp;+%Y.%m.%d`&nbsp;&nbsp;&nbsp;
TIME30=`date&nbsp;--date="-60&nbsp;days"&nbsp;+%Y.%m.%d`
TIME35=`date&nbsp;--date="-60&nbsp;days"&nbsp;+%Y.%m.%d`
TIME1=`date&nbsp;--date="-1&nbsp;days"&nbsp;+%Y.%m.%d`
TIME8=`date&nbsp;--date="-7&nbsp;days"&nbsp;+%Y.%m.%d`
/usr/bin/curl&nbsp;-XDELETE&nbsp;"http://es2.spark:9200/logstash-userlogs-$TIME30/"
/usr/bin/curl&nbsp;-XDELETE&nbsp;"http://es2.spark:9200/packetbeat-http-$TIME35/"

#number_of_replicas&nbsp;num
curl&nbsp;-XPUT&nbsp;http://es2.spark:9200/logstash-userlogs-$TODAY/_settings&nbsp;-d&nbsp;'{&nbsp;"index":&nbsp;{&nbsp;"number_of_replicas"&nbsp;:&nbsp;1&nbsp;}}'&nbsp;&gt;/dev/null&nbsp;2&gt;&1

sleep&nbsp;1

#refresh_interval&nbsp;time
curl&nbsp;-XPUT&nbsp;http://es2.spark:9200/logstash-userlogs-$TODAY/_settings&nbsp;-d&nbsp;'{&nbsp;"index":&nbsp;{&nbsp;"refresh_interval"&nbsp;:&nbsp;"30s"&nbsp;}}'&nbsp;&gt;/dev/null&nbsp;2&gt;&1

sleep&nbsp;1

#optimize&nbsp;yesterday&nbsp;index&nbsp;
echo&nbsp;-e&nbsp;"curl&nbsp;-XPOST&nbsp;'http://es2.spark:9200/logstash-userlogs-$TIME1/_optimize'"&nbsp;&gt;/tmp/optimize_index.sh

#close&nbsp;index
echo&nbsp;-e&nbsp;"curl&nbsp;-XPOST&nbsp;'http://es2.spark:9200/logstash-userlogs-$TIME8/_close'"&nbsp;&gt;&nbsp;/tmp/close_index.sh

#excute&nbsp;command
/bin/sh&nbsp;/tmp/close_index.sh&nbsp;&gt;/dev/null&nbsp;2&gt;&1
sleep&nbsp;1
/bin/sh&nbsp;/tmp/optimize_index.sh&nbsp;&gt;/dev/null&nbsp;2&gt;&


https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html
计算集群中文档的数量
/_count?pretty&nbsp;-d&nbsp;'{"query":{"match_all":&nbsp;{}}}'
查看索引
/_cat/indices?v
查询
/logstash-f1-hq-access-2017.11.16/f1-hq-access/_search?q=client_ip:125.39.46.83
/logstash-f1-hq-access-2017.11.16/f1-hq-access/_search&nbsp;-d&nbsp;'{"query":&nbsp;{"match":&nbsp;{"client_ip":&nbsp;"125.39.46.83"}}}'

curl&nbsp;-XGET&nbsp;'http://192.168.4.5:9200/us/tweet/_search?pretty'&nbsp;-d&nbsp;'{&nbsp;"query":&nbsp;{&nbsp;"match":&nbsp;{&nbsp;"date":&nbsp;"2014-09-24"&nbsp;}}}'
{"query":&nbsp;{"bool":&nbsp;{"must":&nbsp;{"match":&nbsp;{"client_ip":&nbsp;"125.39.46.83"}},"filter":&nbsp;{"range":&nbsp;{"status":&nbsp;{"gt":&nbsp;300&nbsp;}}}}}}
全文搜索
{"query":&nbsp;{"match":&nbsp;{"about"&nbsp;:&nbsp;"rock&nbsp;climbing"}}}
短语搜索
{"query":&nbsp;{"match_phrase":&nbsp;{"about"&nbsp;:&nbsp;"rock&nbsp;climbing"}}}
高亮搜索
{"query":&nbsp;{"match":&nbsp;{"client_ip":&nbsp;"125.39.46.83"}},&nbsp;"highlight":&nbsp;{"fields"&nbsp;:&nbsp;{"client_ip":&nbsp;{}}}}
分析
{"aggs":&nbsp;{"all_status":&nbsp;{"terms":&nbsp;{"field":&nbsp;"status"&nbsp;}}}}
curl&nbsp;-XGET&nbsp;'http://172.16.100.8:9200/logstash-f1-hq-access-2017.12.07/f1-hq-access/_search?pretty'&nbsp;-d&nbsp;'{&nbsp;"query":&nbsp;{"term":&nbsp;{"status":"503"}},"aggs":&nbsp;{"all_host":&nbsp;{"terms":&nbsp;{"field":&nbsp;"http_host.keyword"&nbsp;}}}}'
curl&nbsp;-XGET&nbsp;'http://127.0.0.1:9200/logstash-f1-hq-access-2017.11.30/_mapping/f1-hq-access/'&nbsp;-d&nbsp;'{"properties":&nbsp;{"status":&nbsp;{"type":&nbsp;"text",&nbsp;"fielddata":&nbsp;true}}}'
curl&nbsp;-XGET&nbsp;'http://127.0.0.1:9200/logstash-f1-hq-access-2017.11.30/f1-hq-access/_search?pretty'&nbsp;-d&nbsp;'{"aggs":&nbsp;{"all_status":&nbsp;{"terms":&nbsp;{"field":&nbsp;"status"&nbsp;}}}}'

curl&nbsp;-XGET&nbsp;'http://127.0.0.1:9200/logstash-f1-hq-access-2017.11.30/f1-hq-access/_search?pretty'&nbsp;-d&nbsp;'{"aggs":&nbsp;{"all_status":&nbsp;{"terms":&nbsp;{"field":&nbsp;"status.keyword"&nbsp;}}}}'

curl&nbsp;-H&nbsp;"Content-Type:&nbsp;application/json"&nbsp;-XPOST&nbsp;'http://esuser:s3cr3t@172.16.100.7:8080/_sql?pretty'&nbsp;-d&nbsp;'SELECT&nbsp;count(*)&nbsp;FROM&nbsp;logstash-f1-hq-access-2017.11.30&nbsp;group&nbsp;by&nbsp;status.keyword'
返回文档的一部分
GET&nbsp;/website/blog/123?_source=title,text
创建新文档：
POST&nbsp;/website/blog/
PUT&nbsp;/website/blog/123?op_type=create
PUT&nbsp;/website/blog/123/_create
轻量搜索
GET&nbsp;/_all/tweet/_search?q=tweet:elasticsearch
GET&nbsp;/_search?q=%2Bname%3Ajohn+%2Btweet%3Amary				+name:john&nbsp;+tweet:mary
?q=%2Bname%3A(mary+john)+%2Bdate%3A%3E2014-09-10+%2B(aggregations+geo)	+name:(mary&nbsp;john)&nbsp;+date:&gt;2014-09-10&nbsp;+(aggregations&nbsp;geo)

x-pack&nbsp;security
curl&nbsp;-XPUT&nbsp;'localhost:9200/_xpack/security/user/kibana/_password'&nbsp;-d&nbsp;'{
&nbsp;&nbsp;"password"&nbsp;:&nbsp;"s0m3thgs3cr3t"
}'


</body>
</html>
